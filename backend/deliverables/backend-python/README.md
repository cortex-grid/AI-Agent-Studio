# MAF Backend - Graph-Aware Agent System

Standalone backend generated by Agent Canvas. Uses Microsoft Agent Framework with **graph-aware architecture** to properly handle tools, edges, and orchestration patterns from `project.json`.

## Architecture Overview

This backend parses the full graph structure (nodes + edges) to:
- Assign tools to agents based on edge connections
- Create orchestrated team managers (sequential/concurrent/magentic)
- Instantiate all tool types (MCP, Hosted, Function)
- Support all MAF agent properties (description, temperature, context_providers, etc.)

### Components

- **tool_factory.py** - Creates MAF tool instances from tool nodes
- **graph_builder.py** - Parses edges to build agent-tool mappings and orchestration trees
- **agent_factory.py** - Creates agents with full MAF parameter support
- **main.py** - FastAPI server with graph-aware initialization

## Quick Start

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

### 2. Configure Environment

```bash
cp .env.example .env
```

Edit `.env` with your credentials:
- For **OpenAI**: Set `OPENAI_API_KEY`
- For **Azure AI**: Set `USE_AZURE=true` and `AZURE_PROJECT_ENDPOINT`

### 3. Run Server

```bash
python main.py
```

Or with uvicorn:
```bash
uvicorn main:app --reload --port 8000
```

Server starts at: **http://localhost:8000**

## API Endpoints

### Chat Endpoints

**POST /api/chat/stream** - Streaming chat (NDJSON events)
```json
{
  "message": "Analyze AAPL stock",
  "target": "team",  // or specific agent ID
  "thread_id": "optional-thread-id"
}
```

**POST /api/chat** - Non-streaming chat
Same request format, returns complete response.

### Info Endpoints

**GET /api/agents** - List all agents with metadata
```json
{
  "agents": [
    {
      "id": "agent-1",
      "name": "Financial Analyst",
      "is_manager": false,
      "is_root": true,
      "available": true
    }
  ]
}
```

**GET /api/health** - Health check with agent list
**GET /** - Project info

## Project.json Structure

The backend understands the full graph structure:

```json
{
  "name": "My Agent System",
  "graph": {
    "nodes": [
      {
        "id": "tool-1",
        "type": "tool",
        "data": {
          "subtype": "yahoo-finance",
          "label": "Yahoo Finance"
        }
      },
      {
        "id": "agent-1",
        "type": "agent",
        "data": {
          "label": "Financial Analyst",
          "system": "You analyze financial data.",
          "model": "gpt-4o-mini",
          "temperature": 0.7
        }
      },
      {
        "id": "manager-1",
        "type": "agent",
        "data": {
          "kind": "teamManager",
          "strategy": "sequential",
          "label": "Team Manager"
        }
      }
    ],
    "edges": [
      {"source": "tool-1", "target": "agent-1"},
      {"source": "agent-1", "target": "manager-1"}
    ]
  }
}
```

### Edge Semantics

- **tool → agent**: Agent gets access to this tool
- **agent → manager**: Agent is coordinated by team manager

## Supported Features

### Tool Types

- **MCP Tools**: `mcp-tool` with custom HTTP endpoints
- **Hosted Tools**: `code-interpreter`, `file-search`, `google-search`, `bing-search`
- **Function Tools**: `yahoo-finance`, custom tools from `tools/` directory

### Orchestration Strategies

- **Sequential**: Agents run one after another
- **Concurrent**: Agents run in parallel
- **Magentic**: Planning-based orchestration

Set via `strategy` property on team manager nodes.

### Agent Properties

All MAF parameters supported:
- `name`, `instructions`, `model_id`
- `temperature`, `description`
- `tools` (from edges)
- `context_providers`, `middleware` (advanced)

## How It Works

### Startup Flow

1. Load `project.json` from parent directory
2. **GraphBuilder** parses edges to build agent→tools mappings and orchestration trees
3. **ToolFactory** instantiates all tool nodes
4. **AgentFactory** creates standalone agents with their tools
5. **AgentFactory** creates child agents for team managers
6. **AgentFactory** builds orchestrated managers with strategies
7. Root agents identified and exposed in API

## Adding Custom Tools

1. Create `tools/my_tool.py`:
```python
def my_tool(param: str) -> str:
    """Tool description for MAF."""
    return f"Result: {param}"
```

2. Add tool node to project.json:
```json
{
  "id": "my-tool-1",
  "type": "tool",
  "data": {
    "subtype": "my-tool",
    "label": "My Custom Tool"
  }
}
```

3. Connect to agent with edge:
```json
{"source": "my-tool-1", "target": "agent-1"}
```

## Troubleshooting

### Tool not instantiated
- Check `tools/` directory for implementation file
- Verify filename matches subtype: `my_tool.py` for `my-tool`
- Function should match subtype name or be named `main`

### Agent missing tools
- Verify edges connect tool nodes → agent nodes (direction matters)
- Check startup console for tool creation errors
- Use `GET /api/agents` to verify `available: true`

### Manager has no children
- Verify edges connect agent nodes → manager node
- Manager must have `"kind": "teamManager"` in data (or `"teamDirector"` for a top-level coordinator)
- Check startup console for "Manager has no child agents" warning

### Import errors
- Install MAF: `pip install agent-framework`
- For Azure: `pip install azure-identity`
- Check MAF documentation for hosted tool dependencies

## Environment Variables

**Required:**
- `OPENAI_API_KEY` - OpenAI API key (if using OpenAI)

**Optional:**
- `OPENAI_MODEL` - Default model (default: gpt-4o-mini)
- `USE_AZURE` - Use Azure AI (`true`/`false`)
- `AZURE_PROJECT_ENDPOINT` - Azure AI endpoint
- `BING_CONNECTION_NAME` - For web search tools

## API Documentation

Visit http://localhost:8000/docs for interactive API docs.
